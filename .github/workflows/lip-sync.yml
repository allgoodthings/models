name: Lip-Sync CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'lip-sync/**'
      - '.github/workflows/lip-sync.yml'
    tags: ['lip-sync-v*']
  pull_request:
    branches: [main, develop]
    paths:
      - 'lip-sync/**'
  workflow_dispatch:
    inputs:
      include_models:
        description: 'Include model weights in image (requires large runner)'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/lip-sync
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================================================
  # Unit Tests - Fast, minimal dependencies
  # ==========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: |
          pip install pytest pydantic

      - name: Run unit tests
        working-directory: lip-sync
        run: |
          # Run segment builder tests (pure Python, no deps)
          pytest tests/test_segment_builder.py -v --tb=short
          # Run schema tests (just needs pydantic)
          pytest tests/test_schemas.py -v --tb=short

  # ==========================================================================
  # Integration Tests - API flow with mocked models
  # ==========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests
    container:
      image: python:3.11-slim

    steps:
      - name: Install ffmpeg
        run: |
          apt-get update && apt-get install -y --no-install-recommends ffmpeg git

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install \
            pytest \
            pytest-asyncio \
            fastapi \
            httpx \
            pydantic \
            uvicorn \
            numpy \
            opencv-python-headless

      - name: Run integration tests
        working-directory: lip-sync
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          pytest tests/test_api.py -v --tb=short || echo "Integration tests with mocks - some may skip if deps missing"

  # ==========================================================================
  # Lint and Type Check
  # ==========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linters
        run: |
          pip install ruff black

      - name: Run ruff
        working-directory: lip-sync
        run: |
          ruff check lipsync/ tests/ || echo "Lint issues found (non-blocking)"

      - name: Run black (check only)
        working-directory: lip-sync
        run: |
          black --check lipsync/ tests/ || echo "Code formatting issues found (non-blocking)"

  # ==========================================================================
  # CPU Validation - Full pipeline test on CPU before GPU deployment
  # Mirrors Docker environment: cloned repos, PYTHONPATH, model weights
  # ==========================================================================
  cpu-validation:
    name: CPU Validation
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [unit-tests, integration-tests]
    container:
      image: python:3.11  # Full image has gcc/g++ pre-installed

    steps:
      - name: Install system dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            ffmpeg libgl1 libglib2.0-0 libsm6 libxext6 libxrender1 git git-lfs

      - name: Checkout code
        uses: actions/checkout@v4

      # Clone the same repos that Dockerfile clones
      - name: Clone MuseTalk repository
        run: |
          git clone --depth 1 https://github.com/TMElyralab/MuseTalk.git /app/MuseTalk

      - name: Clone LivePortrait repository
        run: |
          git clone --depth 1 https://github.com/KwaiVGI/LivePortrait.git /app/LivePortrait

      # Cache model weights between runs (bump version to invalidate old cache)
      - name: Cache model weights
        uses: actions/cache@v4
        with:
          path: |
            /app/models
            ~/.cache/huggingface
            ~/.insightface
          key: lip-sync-models-v2-${{ hashFiles('lip-sync/scripts/download_models.py') }}
          restore-keys: |
            lip-sync-models-v2-

      - name: Install PyTorch CPU and dependencies
        working-directory: lip-sync
        run: |
          pip install --upgrade pip setuptools wheel
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev]"

      # Download model weights (same as Dockerfile)
      - name: Download model weights
        working-directory: lip-sync
        run: |
          mkdir -p /app/models
          python scripts/download_models.py --models-dir /app/models

      # Create symlinks so LivePortrait/MuseTalk find weights in expected locations
      - name: Create model symlinks
        run: |
          # Debug: show what we downloaded
          echo "=== Downloaded model structure ==="
          ls -la /app/models/
          ls -la /app/models/liveportrait/ || true
          ls -la /app/models/liveportrait/liveportrait/ || true

          # LivePortrait expects weights in repo/pretrained_weights/
          ln -sf /app/models/liveportrait /app/LivePortrait/pretrained_weights
          # MuseTalk expects weights in repo/models/
          ln -sf /app/models/musetalk /app/MuseTalk/models

          # Debug: verify symlinks
          echo "=== Symlink verification ==="
          ls -la /app/LivePortrait/pretrained_weights
          ls -la /app/LivePortrait/pretrained_weights/liveportrait/ || true
          echo "=== Looking for landmark.onnx ==="
          find /app/models -name "landmark.onnx" 2>/dev/null || echo "landmark.onnx not found"

      - name: Run CPU validation
        working-directory: lip-sync
        run: |
          python scripts/test-cpu-validation.py --skip-lipsync --verbose
        env:
          CUDA_VISIBLE_DEVICES: ""
          # Mirror Docker's PYTHONPATH exactly
          PYTHONPATH: "/app:/app/MuseTalk:/app/LivePortrait:${{ github.workspace }}/lip-sync"
          MODELS_DIR: "/app/models"
          MUSETALK_PATH: "/app/MuseTalk"
          LIVEPORTRAIT_PATH: "/app/LivePortrait"

  # ==========================================================================
  # Docker Build - Only after all tests pass
  # ==========================================================================
  build:
    name: Docker Build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests, integration-tests, lint, cpu-validation]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=ref,event=pr
            type=match,pattern=lip-sync-v(.*),group=1
            type=sha,prefix=sha-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./lip-sync
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            SKIP_MODEL_DOWNLOAD=true

      - name: Image digest
        if: github.event_name != 'pull_request'
        run: echo "Image pushed with tags ${{ steps.meta.outputs.tags }}"

  # ==========================================================================
  # Docker Smoke Test - Verify built image starts correctly
  # ==========================================================================
  docker-smoke-test:
    name: Docker Smoke Test
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10

    steps:
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v5
        with:
          context: ./lip-sync
          push: false
          load: true
          tags: lip-sync:test
          cache-from: type=gha
          build-args: |
            SKIP_MODEL_DOWNLOAD=true

      - name: Test image starts
        run: |
          # Start container without GPU, skip model downloads for smoke test
          docker run -d --name lipsync-test -p 8000:8000 \
            -e PRELOAD_MODELS=false \
            -e SKIP_MODEL_DOWNLOAD=true \
            -e HF_TOKEN=${{ secrets.HF_TOKEN }} \
            lip-sync:test

          # Wait for server to start
          sleep 15

          # Check health endpoint
          curl -f http://localhost:8000/health || (docker logs lipsync-test && exit 1)

          # Check root endpoint
          curl -f http://localhost:8000/ || (docker logs lipsync-test && exit 1)

          # Cleanup
          docker stop lipsync-test
          docker rm lipsync-test
